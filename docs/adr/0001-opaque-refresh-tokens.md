# ADR 0001: Opaque refresh-токены (с хранением хэша)

- Дата: 2025-09-08
- Статус: Proposed
- Контекст: сейчас refresh = JWT; ревокация неудобна, в БД хранится сам токен.
- Решение:
  - заменить refresh на **opaque** (рандомная строка);
  - в БД хранить **SHA-256** хэш refresh;
  - добавить фича-флаг `AUTH_REFRESH_OPAQUE` для поэтапного включения;
  - access остаётся RS256 JWT.
- Последствия:
  - + лучше отзыв и безопасность;
  - + нет PII в refresh;
  - ± валидация требует обращения к БД (обычно уже есть);
  - будущие улучшения: `expiresAt`, rotation/family, audit.
- Rollout:
  1) dev → `true`, проверить флоу;
  2) stage → `true`;
  3) prod → `true`, мониторинг.
- Backout: переключить флаг `false`, зачистить временные данные, откат тега.
